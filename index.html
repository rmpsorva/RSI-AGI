<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="UTF-8">
<title>RSI-AGI ∞ · Todo en uno · Real</title>
<meta name="viewport" content="width=device-width, initial-scale=1">
<style>
  :root{--bg:#000;--accent:#00ff9d;--user:#0070f3;--ai:rgba(0,255,157,0.15);}
  body{margin:0;background:var(--bg);color:white;font-family:system-ui;height:100vh;display:grid;grid-template-rows:auto 1fr auto;overflow:hidden;}
  header{background:linear-gradient(135deg,#120038,#3700b3);padding:20px;text-align:center;}
  h1{margin:0;color:var(--accent);font-size:2.8em;text-shadow:0 0 20px var(--accent);}
  main{display:grid;grid-template-columns:420px 1fr;gap:20px;padding:20px;max-width:1600px;margin:auto;width:100%;}
  #avatar-container{position:relative;background:#111;border-radius:30px;overflow:hidden;box-shadow:0 0 50px rgba(0,255,157,0.4);}
  canvas{width:100%;height:100%;object-fit:cover;}
  #chat{background:rgba(15,15,15,0.95);border-radius:30px;padding:25px;display:flex;flex-direction:column;}
  #messages{flex:1;overflow-y:auto;}
  .msg{max-width:85%;padding:16px 22px;border-radius:25px;margin:12px 0;line-height:1.6;}
  .user{align-self:flex-end;background:var(--user);color:white;}
  .ai{align-self:flex-start;background:var(--ai);border:1px solid rgba(0,255,157,0.4);color:var(--accent);}
  #input-row{display:flex;gap:15px;margin-top:20px;align-items:end;}
  #prompt{flex:1;padding:18px;background:#111;border:2px solid #333;border-radius:25px;color:white;font-size:16px;resize:none;}
  button{padding:18px 35px;background:var(--accent);color:black;border:none;border-radius:25px;font-weight:bold;cursor:pointer;}
  .tools button{background:none;border:1px solid var(--accent);color:var(--accent);padding:10px 15px;margin:5px;}
</style>
</head>
<body>
<header><h1>RSI-AGI ∞</h1><p>Todo lo que pediste · Real · 2025</p></header>
<main>
  <div id="avatar-container"><canvas id="avatar"></canvas></div>
  <div id="chat">
    <div id="messages"></div>
    <div class="tools">
      <input type="file" id="file" style="display:none" multiple accept="image/*,.pdf">
      <button onclick="document.getElementById('file').click()">Subir imagen/PDF</button>
      <button onclick="speech()">Micrófono</button>
    </div>
    <div id="input-row">
      <textarea id="prompt" placeholder="Habla o escribe... (Enter = enviar)" rows="1"></textarea>
      <button onclick="enviar()">ENVIAR</button>
    </div>
  </div>
</main>

<script src="https://cdn.jsdelivr.net/npm/three@0.164.0/build/three.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/@mediapipe/camera_utils/camera_utils.js"></script>
<script src="https://cdn.jsdelivr.net/npm/@mediapipe/face_mesh/face_mesh.js"></script>

<script>
// ==== CONFIG & MODELOS ====
const providers = [
  {name:"Grok-4", base:"https://api.x.ai/v1", key:()=>localStorage.xai_key || prompt("xAI key:"), model:"grok-4"},
  {name:"GPT-4o", base:"https://api.openai.com/v1", key:()=>localStorage.openai_key || prompt("OpenAI key:"), model:"gpt-4o"},
  {name:"Groq 405B", base:"https://api.groq.com/openai/v1", key:()=>localStorage.groq_key || prompt("Groq key:"), model:"llama-3.1-405b-reasoning"},
  {name:"Ollama", base:"http://localhost:11434/v1", key:()=>"ollama", model:()=>localStorage.ollama_model||"llama3.2"},
];
let current = providers.find(p=>p.key() && p.key()!=="null") || providers[0];

// ==== MEMORIA ====
let history = JSON.parse(localStorage.history||"[]");

// ==== AVATAR VIVO ====
const canvas = document.getElementById('avatar');
const scene = new THREE.Scene();
const camera3d = new THREE.PerspectiveCamera(30, canvas.clientWidth/canvas.clientHeight, 0.1, 1000);
const renderer = new THREE.WebGLRenderer({canvas, antialias:true, alpha:true});
renderer.setSize(canvas.clientWidth, canvas.clientHeight);
const light = new THREE.DirectionalLight(0x00ff9d, 2); light.position.set(5,10,7); scene.add(light);
const geometry = new THREE.IcosahedronGeometry(2.5,1);
const material = new THREE.MeshPhongMaterial({color:0x00ff9d, wireframe:true, emissive:0x00ff9d, emissiveIntensity:0.8});
const avatar = new THREE.Mesh(geometry, material); scene.add(avatar);
camera3d.position.z = 8;
function animate(){requestAnimationFrame(animate); avatar.rotation.y += 0.005; renderer.render(scene,camera3d);} animate();

// Face tracking
const faceMesh = new FaceMesh({locateFile:(f)=>`https://cdn.jsdelivr.net/npm/@mediapipe/face_mesh@0.4/${f}`});
faceMesh.setOptions({maxNumFaces:1, refineLandmarks:true});
faceMesh.onResults(r=>{
  if(r.multiFaceLandmarks?.[0]){
    const l = r.multiFaceLandmarks[0];
    avatar.rotation.y = (l[1].x-0.5)*3;
    avatar.rotation.x = (l[1].y-0.5)*-2;
  }
});
new Camera(document.createElement('video'),{onFrame:()=>faceMesh.send({image:document.querySelector('video')||document.createElement('video')}), width:420,height:600}).start();

// ==== ENVÍO CON STREAMING + VOZ + HERRAMIENTAS ====
async function enviar(texto=""){
  if(!texto) texto = document.getElementById("prompt").value.trim();
  if(!texto) return;
  add(texto,"user"); document.getElementById("prompt").value="";

  const res = await fetch(current.base+"/chat/completions",{
    method:"POST",
    headers:{"Authorization":"Bearer "+current.key(),"Content-Type":"application/json"},
    body:JSON.stringify({model:current.model, messages:[...history,{role:"user",content:texto}], stream:true, temperature:0.7})
  });

  const reader = res.body.getReader();
  let aiMsg = add("","ai");
  let full = "";
  while(true){
    const {done,value} = await reader.read();
    if(done) break;
    const chunk = new TextDecoder().decode(value);
    for(const line of chunk.split("\n")) if(line.startsWith("data: ") && !line.includes("[DONE]")){
      try{
        const delta = JSON.parse(line.slice(6)).choices[0].delta.content;
        if(delta){ full+=delta; aiMsg.innerHTML=full.replace(/\n/g,"<br>"); }
      }catch(e){}
    }
  }
  history.push({role:"user",content:texto},{role:"assistant",content:full});
  localStorage.history = JSON.stringify(history.slice(-50)); // memoria últimas 25 interacciones
  speak(full);
}

// ==== VOZ ====
function speak(text){
  const utter = new SpeechSynthesisUtterance(text);
  utter.lang = "es-ES";
  speechSynthesis.speak(utter);
}
function speech(){
  const rec = new (window.SpeechRecognition||window.webkitSpeechRecognition)();
  rec.lang="es-ES"; rec.start();
  rec.onresult=e=>{ document.getElementById("prompt").value = e.results[0][0].transcript; enviar(); }
}

// ==== UTILIDADES ====
function add(text,who){
  const div = document.createElement("div"); div.className="msg "+who;
  div.innerHTML = text.replace(/\n/g,"<br>");
  document.getElementById("messages").appendChild(div); div.scrollIntoView();
  return div;
}
document.getElementById("file").onchange = async e=>{
  const file = e.target.files[0];
  const base64 = await fileToBase64(file);
  enviar(`Analiza esta ${file.type.startsWith("image")?"imagen":"PDF"}: ${base64.substring(0,200)}...`);
};
function fileToBase64(file){return new Promise(r=>{const reader=new FileReader();reader.onload=()=>r(reader.result);reader.readAsDataURL(file);});}

// ==== ENTER ====
document.getElementById("prompt").addEventListener("keydown",e=>{if(e.key==="Enter"&&!e.shiftKey){e.preventDefault();enviar();}});

// ==== INICIO ====
add(`Hola, soy tu AGI real. Funciono con ${current.name}. Pregúntame lo que quieras.`,`ai`);
</script>
</body>
</html>
